import os
import argparse
from surround import Surround, Assembler, Config
from surround.experiment import ExperimentWriter
from stages import Baseline, InputValidator, ReportGenerator
from file_system_runner import FileSystemRunner

runners = [
    FileSystemRunner()
]

assemblies = [
    Assembler("baseline")
        .set_validator(InputValidator())
        .set_estimator(Baseline())
        .set_visualiser(ReportGenerator())
]

def main():
    config = Config(auto_load=True)
    default_runner = config.get_path('runner.default')
    default_assembler = config.get_path('assembler.default')

    parser = argparse.ArgumentParser(prog='{project_name}', description="Surround mode(s) available to run this module")
    
    parser.add_argument('-r', '--runner', help="Runner for the Assembler (index or name)", default=default_runner if default_runner is not None else "0")
    parser.add_argument('-a', '--assembler', help="Assembler to run (index or name)", default=default_assembler if default_assembler is not None else "0")
    parser.add_argument('-e', '--experiment', help="Consider this run an experiment", action="store_true")
    parser.add_argument('-ne', '--no-experiment', help="Don't consider this run an experiment", action="store_true")
    parser.add_argument('-n', '--note', help="Add a note to the experiment", type=str)
    parser.add_argument('--mode', help="Mode to run (train, batch)", default="batch")
    parser.add_argument('--status', help="Display information about the project such as available runners and assemblers", action="store_true")

    args = parser.parse_args()

    if args.experiment and not args.no_experiment:
        writer = ExperimentWriter()
        writer.write_project('{project_name}', '{project_description}')

        notes = [args.note] if args.note else []
        writer.start_experiment('{project_name}', os.path.join(os.path.dirname(__file__), ".."), vars(args), notes)

    surround = Surround(runners, assemblies)

    if args.status:
        surround.show_info()
    else:
        runner = surround.run(args.runner, args.assembler, args.mode)

        if args.experiment and not args.no_experiment:
            writer.stop_experiment(metrics=runner.assembler.state.metrics)

if __name__ == "__main__":
    main()
